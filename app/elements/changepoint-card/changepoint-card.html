<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-styles/paper-styles.html">
<script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../changepoint-service/changepoint-service.html">
<link rel="import" href="../changepoint-list/changepoint-list.html">
<link rel="stylesheet" type="text/css" href="../../styles/styles.css">
<dom-module id="changepoint-card">
  <template>
  <style>
  .card{  
   @apply(--layout-center);
  }
  .template{
    margin-left: -5%;
  }
  .hrlayout
  {
    margin-left: 20%;
     @apply(--layout-horizontal);
  }
  .hrspace
  {
    padding-left: 3%;
    padding-top: 5%;
  }


  </style>
    <body>
      <div class = "mapstudenttopoint-card">
      <div class="card">
        <div class="hrlayout">

        </div>
         <div id="search">
            <paper-input label="Enter Student/Class ID/Student Name" value="{{value}}" on-keydown="FnInputChanged"></paper-input>
            <paper-listbox id="itemlist" class="dropdown-content" on-iron-select="FnItemSelected">
              <template is="dom-repeat" items="{{itemArray}}" as="item">
                <paper-item value="{{item.itemid}}">{{item.itemdes}}</paper-item>
              </template>
            </paper-listbox>
          </div>
      </div>    
      <div class="template">
        <!-- <app-service studentarr="{{studentarr}}"></app-service> -->
          <template  is="dom-repeat" items="{{studentarr}}">
            <changepoint-list schooltype="{{item.school_type}}" studentid="{{item.id}}" studentname="{{item.student_name}}" tripid="{{school_type}}" ></changepoint-list>
          </template>
          <div class="button" style="margin-left: 50%;margin-top: 3%; height: 40% !important;">
            <paper-button raised id="submitbutn1" class="custom indigo" on-click="click">Submit</paper-button>
          </div>

          <div class="button" style="margin-left: 58%;margin-top: -2.5%; height: 40% !important;">
            <paper-button raised id="deletebutn1" class="custom indigo" on-click="fndelete">Delete</paper-button>
          </div>
        </div>
      </div>
    </body>   
    <changepoint-service id="maps"></changepoint-service>
  </template>
  <script>
    (function() {
      var itemarray=[];
      var namearr=[];
      Polymer({
        is:"changepoint-card",
        ready:function()
        {
          this.$.submitbutn1.hidden=true;
          this.$.deletebutn1.hidden=true;
          this.$.submitbutn1.disabled=true;
          this.$.deletebutn1.disabled=true;
          this.querySelector('paper-listbox').style.visibility='hidden';
         },
         FnClear:function()
         {
          this.$.submitbutn1.hidden=true;
          this.$.deletebutn1.hidden=true;
          this.classarr="";
          this.value="";
          this.itemArray="";
          this.studentarr="";
         },
        fnrefreshpoint:function(){
          this.studentarr=[];
          this.$.maps.selectclass();
        },
        changeHandler:function(e){
       if(e.target.checked==true)
        {
          this.$.search.hidden=false;
          this.$.maps.selectname();
          this.studentarr=[];
          document.querySelector('#gradeselect').selected=-1;
          document.getElementById("submitbutn1").style.background="grey";
          document.getElementById("deletebutn1").style.background="grey";

        }
        else
        {
          this.$.search.hidden=true;
        }

        },
        classes1:function(e){
          this.studentarr=[];
          this.class = (e.target.selectedItem.value);
          this.$.maps.classpick(this.class);
          this.$.submitbutn1.hidden=false;
          this.$.deletebutn1.hidden=false;

           this.$.search.hidden=true;
           document.querySelector("#selectbox").checked=false;
          document.getElementById("submitbutn1").style.background="grey";
          document.getElementById("deletebutn1").style.background="grey";
        },
        autocompletename(nameitem)
        {
          namearr=nameitem;
        },
        FnInputChanged:function(e){
          if(e.keyCode==13|| e.keyCode==40)
            this.querySelector('paper-listbox').focus();
          var arr=[];
          arr.push({"itemdes":"-----Select-----"});
          this.querySelector('paper-listbox').style.visibility='visible';
          if(e.keyCode==8){
            this.itemflag="true";  
            this.itemval="";
            //alert('yes');
            var len=(this.value).length;
            if(len<=1){
              this.querySelector('paper-listbox').style.visibility='hidden';
              this.itemArray="";
              this.itemval="";
            }
            if(len>1){
              this.querySelector('paper-listbox').style.visibility='visible';
              var backsubval=(((this.value).substring(0,(len-1))).trim()).toUpperCase();
              for(var i=0;i<namearr.length;i++)
              {
                var subval=((namearr[i].student_name).trim()).substring(0,backsubval.length);
                if((subval).toUpperCase()==(backsubval).toUpperCase())
                {
                  var obj={"itemdes":"","itemid":""};
                  obj.itemdes=namearr[i].student_name;
                  obj.itemid=namearr[i].id;
                  arr.push(obj);
                }
              }
              this.itemArray=arr;
            }
          }
          if(e.keyCode!=8&& e.keyCode!=16&& e.keyCode!=13 && e.keyCode!=38&&e.keyCode!=40&&e.keyCode!=37&&e.keyCode!=39){
            if(this.itemflag=="true") {
              this.itemval = (this.value).toUpperCase()+String.fromCharCode((e.keyCode)).toUpperCase();
              this.itemflag="false";
            }   
            else
            this.itemval = this.value +String.fromCharCode((e.keyCode));
            if(this.itemval.length>0)
            {
              for(var i=0;i<namearr.length;i++){
                var subval=((namearr[i].student_name).trim()).substring(0,this.itemval.length);
                if((subval).toUpperCase()==(this.itemval).toUpperCase()){
                  var obj={"itemdes":"","itemid":""};
                  obj.itemdes=namearr[i].student_name;
                  obj.itemid=namearr[i].id;
                  arr.push(obj);
                }
              }
              if(arr.length>0)
                this.itemArray=arr;
              else {
                var obj={"itemdes":"","itemid":""};
                  obj.itemdes=namearr[i].student_name;
                  obj.itemid=namearr[i].id;
                  arr.push(obj);
                this.itemArray=arr;
              }
            }
          }
        },
        FnItemSelected:function(e)
        {
          this.querySelector('paper-listbox').style.visibility='hidden';
          this.studid= e.target.selectedItem.value;
          var studname=(e.target.selectedItem.textContent).trim();
          this.value=studname;
          this.$.submitbutn1.hidden=false;
          this.$.deletebutn1.hidden=false;
          this.$.maps.namepick(this.studid);
           this.$.maps.fnset(this.studid);
       
          //document.querySelector('changepoint-list').fnsetval();
          this.itemArray=[];
          this.querySelector('paper-listbox').selected=-1;
        },
        click:function(){
          this.$.maps.submit(itemarray);
          //alert(JSON.stringify(itemarray));
          itemarray=[];
          document.querySelector('#gradeselect').selected=-1;
          this.value="";
          this.$.submitbutn1.disabled=true;
          this.$.deletebutn1.disabled=true;

        },
        FnGetItemsz:function(studentid,pickroute,droproute,pickpoint,droppoint)
           {
           // alert("test");
            var trip;
            if(this.class=="Primary")
            {
              trip="1";
            }
            else
            {
              trip="2";
            }
            var obj={"studentid":"","class_id":"","pickroute":"","droproute":"","pickpoint":"","droppoint":""};
            obj.studentid=studentid;
            obj.class_id=trip;
            obj.pickroute=pickroute;
            obj.droproute=droproute;
            obj.pickpoint=pickpoint;
            obj.droppoint=droppoint;
            itemarray.push(obj);
         //  alert(JSON.stringify(obj));
            this.$.submitbutn1.disabled=false;
             document.getElementById("submitbutn1").style.background="black";
             this.$.deletebutn1.disabled=false;
             document.getElementById("deletebutn1").style.background="black";
           },
           removestud:function(std)
           {
              for(var i=0;i<itemarray.length;i++)
             {
               if(std==itemarray[i].studentid)
               {
                itemarray.splice(i,1);
               }
             }
             this.$.submitbutn1.disabled=true;
             document.getElementById("submitbutn1").style.background="grey";
             this.$.deletebutn1.disabled=true;
             document.getElementById("deletebutn1").style.background="grey";
           },
           fndelete:function()
           {
              this.$.maps.delete(this.studid);
            //  alert('1');
               this.$.maps.selectname1();
                itemarray=[];
              this.value="";
              this.$.deletebutn1.disabled=true;
              this.$.submitbutn1.disabled=true;
           },

      });
    })();
  </script>
</dom-module>
